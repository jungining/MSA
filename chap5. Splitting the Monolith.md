# 5. Monolith 분해하기

> 하나의(mono-) 돌(lith), 단일체

어떻게 모놀리식 Application의 분해를 시작할 수 있을까?

## 접합부(Seam)가 중요하다.
- 모놀리스의 문제는 응집력이 낮고, 느슨한 결합이 존재하지 않는다는 것이다.
- Seam(접합부) : 코드베이스의 나머지 부분에 영향을 주지 않는 격리된 코드 부분
- 경계가 있는 콘텍스트는 훌륭한 접합부를 만든다.

## 뮤직코퍼레이션 분해하기

0. 경계가 있는 콘텍스트를 인식

1. 콘텍스트를 대표하는 패키지를 생성

2. 기존 코드를 패키지로 이동

    - 점진적 접근 : 이 과정은 천천히 조금씩 진행되어야 한다.

## 모놀리스를 분리하는 이유

- 변경의 속도 : 접합부는 독립된 자율적 개체가 되어 신속하게 변경 가능하다.
- 팀 구조 : 팀이 주로 작업하는 코드를 분리할 수 있다면 좋다.
- 보안 : 개별 서비스를 모니터링 가능 / 데이터의 전송, 저장에 있어 추가 보호 가능
- 기술 : 다른 구현 방식을 쉽게 고려할 수 있다.

## 뒤엉킨 의존성

- 또 고려할점 : 그 코드가 시스템의 나머지 부분과 어떻게 엉켜져 있는가
    - 보통 뒤엉킨 의존성의 출처는 DB다.


## 데이터베이스

아래 두 가지를 신경써서 데이터베이스에서 접합부를 찾아 모놀리스를 분해해보자.

- 테이블 간의 결합을 어떻게 끊을 것인가?
- 테이블이 다수의 경계가 다른 콘텍스트에 사용되는 경우에는 어떻게 할 것인가?

### 외부 키 관계 깨트리기

때로는 테이블 간의 결합을 끊는 대가로 저하된 성능을 갖는것이 옳을 때가 있다.

### 공유 정적 데이터

여러 서비스가 참조하는 국가 코드가 있다고 생각해보자. 이 공유 국가 코드 테이블을 참조하게 된다면 어떻게 해야 할까?

1. 테이블을 각 패키지에 복제 - 일관성 문제 O
2. enum 등 코드로 만들어 다룸 - 변경이 더 용이하겠지만, 일관성 문제 O
3. 특정 독립적인 서비스 안에 삽입 - 약간 과분

### 공유 데이터

창고와 재무 서비스가 참조하고 있는 고객 레코드 테이블을 임시 단계로 Customer로 명명된 새로운 별도의 패키지로 만들고, Customer코드를 API를 통해 사용할 수 있다.

### 공유 테이블

다르게 저장될 수 있는 분리된 두 가지 개념이 있는지 확인하여 테이블을 분리하자.


## 데이터베이스 리팩토링
- 단계적인 분리 : 애플리케이션을 분리시켜 마이크로서비스로 만들기 전에, 서비스는 하나로 유지한 채 우선 스키마를 분리하고, 그 후에 애플리케이션 코드를 두개의 서비스로 분리하는 것을 고려하자.

## 트랜잭션의 경계
트랜잭션은 이벤트가 모두 발생하거나 전혀 발생하지 않게 해준다. 데이터베이스를 분리할 경우 단일 트랜잭션에 의해 제공된 안정성을 잃는다.

트랜잭션에 실패하면 어떻게 될까? 아래와 같은 방법들이 있다.

1. 나중에 재시도하기 : 로그 파일에 큐잉하여 나중에 재시도 
2. 전체 작업 중지 : 되돌릴 새로운 트랜잭션을 발생
3. 분산 트랜잭션 : 2단계 커밋을 사용

그렇다면 무엇을 해야 하나?
    
    - 처음부터 그 상태가 유지되도록 할 수 있는 모든것을 하라
    

## 리포팅
- 유용한 결과를 생성하기 위해 조직 내 여러부분의 데이터를 모아서 보는것(ex. 구매 행동 패턴 모니터링)
- 이용 대상 : 평범한 사용자
- 데이터의 저장방법과 장소를 잠재적으로 분리하는 것은 리포팅에 문제가 될 수 있다

정보가 서로 다른 시스템에 저장되어 있다면 리포팅시에 어떻게 해야할까? 몇 가지 방안을 생각해보자.

## 서비스 호출을 통한 데이터 추출
- API를 통한 데이터 추출
- 대용량 데이터를 필요로 할 때 서비스에 부하가 될 수 있다.
- 대안 : 배치 API 재공

## 데이터 펌프

- 리포팅 시스템이 데이터를 끌어오는 방식이 아닌 리포팅시스템에 데이터를 밀어 넣는 방식
- Cron과 같이 단순한 명령행 프로그램을 개발하고 관리해야 한다.
- 데이터 펌프를 서비스 자체 빌드의 일부로 추가해 부차 결과물로 생성
- 글쓴이 사용 예 : JSON파일을 AWS S3에 저장하기 위해 데이터 펌프 사용.

## 이벤트 데이터 펌프
- 정기적으로 데이터를 밀어넣는것이 아니라 이벤트가 발생할때만 데이터가 리포팅 시스템에 갈 수 있도록 함
- 변경된 내용(delta)만 리포팅 시스템에 보냄 
- 서비스 내부와 더 약하게 결합됨
- 단점 : 모든 정보를 이벤트로 확산해야함

## 백업 데이터 펌프
- 넷플릭스에서 사용중, 기존의 백업 솔루션 활용
- 카산드라(Apache Cassandra - 분산형 NoSQL 데이터베이스 관리 시스템) 이용

## 원인 파악
- 왜 처음부터 크게 자라게 되었는가?
- 분해가 필요한 시점까지 자라는건 괜찮다. 분리하는 작업이 필요하다는 사실을 인식하는것이 핵심이다.
- 서비스 분리와 관련된 변경 비용이 크기때문.. 

정리 : 드러난 서비스 경계에 따라 접합부를 찾아서 시스템을 점진적으로 분해
