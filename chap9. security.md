# 9. 보안

- 한 지점에서 다른 지점으로 데이터를 전송 / 저장할 때 어떠한 보호가 필요한지
- 하부 운영 체제와 네트워크의 보안에 대해 고려

## 9.1 인증과 권한부여
- 인증(Authentication) : 자신이라고 말하는 당사자를 확인하는 과정 (ex. 사용자 이름 / 비밀번호 / 지문인증)
- 권한주체(principal) : 인증되는 사람 또는 사물에 대해 추상적으로 표현
- 권한부여(Authorization) : 권한주체를 허용된 행위와 매핑하는 매커니즘 (ex. 사람이 할 수 있는것과 할 수 없는것 결정)

단일 모놀리식 애플리케이션의 경우, 애플리케이션 스스로 인증과 권한부여를 처리한다. 하지만 분산 시스템에서는 각각의 시스템에 각기 다른 사용자 이름과 비밀번호를 사용하여 로그인하기를 원하지 않는다. 목표는 단일 신원을 보유하는 것이다.

### 1. 일반적인 SSO 구현체
![image](https://doubleoctopus.com/wp-content/uploads/2018/05/SSO-processxml.png)

1. 권한주체가 리소스에 접근하려 함
2. 신원 제공자에 권한주체 재전송
3. 권한주체의 사용자 이름 / 비밀번호 / 이중 요소 인증 제공
4. 인증이 충족되면 신원 제공자는 권한주체의 자원 접근 허용 여부를 결정하도록 서비스 제공자에 정보 전달함

- 대표적인 구현체 
    - SAML(Security Assertion Markup Language)
        - 인증 정보 제공자(identity provider)와 서비스 제공자(service provider) 간의 인증 및 인가 데이터를 교환하기 위한 XML 기반의 개방형 표준 데이터 포맷
        - 작업이 꽤 복잡)
    - 구글의 OpenID Connect
        - openid라는 scope 값을 포함해서 Authorization Request를 보내며 Authentication에 대한 정보는 ID Token 이라고 불리는 JSON Web Token(JWT)을 리턴
        - 더 단순한 REST 호출을 사용하고, 사용 편의성이 향상되어 기업 시장으로 진출

### 2. 싱글 사인온 게이트웨이

- SSO 게이트웨이 사용시 이점
    - 각 서비스가 신원 제공자를 경유하고 핸드셰이킹을 각각 하도록 하지 않을 수 있다. 
    - 침입시 HTTPS를 종료 하거나 침입 탐지 적용 등을 하도록 결정할 수 있다.

### 3. 세분화된 권한 부여
- 게이트웨이는 상당히 효과적인 큰 단위의 인증 기능을 제공하는 것이 가능
- 특정 자원 또는 엔드포인트에 대한 접근의 허용 여부는 마이크로서비스 자체에 맡겨야 함

## 9.2 서비스 대 서비스 인증과 권한부여
권한주체가 프로그램이나 서비스가 된다면 서로 인증시 어떻게 해야 하나?

### 1. 경계 안의 모든 것 허용하기
- 특정 경계 내부의 모든 호출을 암묵적으로 신뢰한다고 가정
- 중간자 공격(네트워크 통신을 조작하여 통신 내용을 조작하거나 도청하는 공격 기법)에 약할수밖에 없다.

### 2. HTTP(S) 기본 인증
- HTTP : 클라이언트가 사용자 이름과 패스워드를 표준 HTTP헤더에 넣어서 전송
- 서버는 상세 내용을 확인하고 클라이언트의 서비스 접근 허용 여부를 승인
- 하지만, 안전한 방식으로 사용자 이름과 패스워드를 전송할 수 없으므로 문제가 많다.
- 네트워크상의 어떠한 중간자도 헤더 정보와 데이터를 볼 수 있으므로 HTTP 기본 인증은 대개 HTTPS 상에서 수행되어야 한다.

### 3. SAML 또는 OpenID Connect 사용하기
- SAML 또는 OpenID Connect도 서비스 대 서비스 통신용으로도 사용가능하다.
- 기존의 인프라스트럭처를 사용할 수 있고 모든 서비스의 접근 통제를 중앙의 디렉터리 서버에 모아서 처리할 수 있다.
### 4. 클라이언트 인증서
- (SSL의 계승자인) 클라이언트 인증서 형태의 전송 계층 보안(TLS/Transport Layer Security) 기능을 이용
- 클라이언트와 서버의 연결을 체결할 때 사용되는 X.509 인증서가 각 클라이언트에 설치, 서버는 클라이언트 인증서의 진위를 검증하여 유효한 클라이언트인지 보장

### 5. HTTP 기반의 HMAC
- HTTPS 트래픽이 서버에 부담을 줄 수 있고, HTTPS 트래픽은 캐시하기도 쉽지 않다.
- 대안은 OAuth 명세서 일부와 AWS S3 API에 의해 폭넓게 사용되는 해시 기반 메시징 코드(HMAC/hash-based messaging code)를 HTTP 요청의 서명에 사용하는 것
- HMAC 원리
    - HMAC에서 요청 메시지 바디는 비밀 키를 사용해서 해시되고 해시 결과는 요청과 함께 전송한다.
    - 서버는 자신이 가진 비밀 키의 복제본을 사용해서 해시를 재생성한다.
    - 1과 2가 일치한다면 서버는 그 요청을 수락한다.
- HMAC 장점 
    - 누군가 중간에 요청을 변조한다면 해시는 일치하지 않을 것이고, 서버는 그 요청이 변조되었다는 것을 알 수 있다.
    - 비밀 키는 절대 요청에 넣어 전송하지 않으므로 통신상에서 누출 될 수도 없다.
    - 트래픽이 더 쉽게 캐쉬되고, 해시를 생성하는 부하가 HTTPS 트래픽을 처리하는 것보다 더 낮다
- HMAC 단점
    - 클라이언트와 서버 모두 어떤 방식으로든 통신해서 기밀을 공유해야 한다.
    - 하나의 패턴이지, 표준은 아니므로 다양한 구현 방법이 있다.
    - 제3자가 요청 내용을 조작하지 않았다는 것과 비밀 키 자체의 기밀성(전송하지 않으므로)만 보장하는 것
    
### 6. API 키
- 트위터, 구글, 플리커, AWS 가 사용
- 공개 키와 개인키를 짝으로 사용

## 9.3 보관 중인 데이터 보호하기
- 심층 방어가 필요하다. 
- 잘 알려진 인정된 암호화 알고리즘(AES)을 사용하라.
- 패스워드에 대해서는 솔트를 이용한 패스워드 해싱을 고려해야 한다. 
- 키는 키 금고에 저장하자. (DB, Code등과 분리)
- 데이터를 처음 볼 때 그것을 암호화해라.
- 백업 또한 암호화되었는지 확인해야 한다.

## 9.4 심층 방어
- 방화벽
- 로깅 : 나쁜 일의 탐지와 회복에 도움이 될 수 있다. 민감 정보 로그 조심!
- 침입 탐지(IDS) / 방지(IPS) 시스템 : 
- 네트워크 분리(망 분리) : 마이크로서비스에서는 서비스들의 상호 통신 방법의 통제를 세분화하도록 서비스들을 다른 네트워크 세그먼트에 배치할 수 있다. (ex. AWS 가상 사설 클라우드를 자동적으로 프로비저닝 하는 기술)
- 운영 체제 : 보안 취약점을 위해 정기적으로 패치하고, 리눅스를 사용중이라면 보안 모듈을 살펴보라. (ex. 앱아머)

## 9.5 시범 예제

![image](https://user-images.githubusercontent.com/11023497/123658693-ebdb0880-d86c-11eb-8b4c-25b962c2d6ac.png)

![image](https://user-images.githubusercontent.com/11023497/123658763-fc8b7e80-d86c-11eb-8ac6-541993b736a9.png)


## 9.6 절약하라
- 저장하는 데이터를 최소화해서 훔쳐갈 것이 없도록 해라.
- 절대적으로 필요한 만큼의 정보만 저장

## 9.7 인적 요소
- 조직 내 인적 요소를 다루기 위한 프로세스와 정책 (ex. 퇴사자의 자격증명 접근) 주의
- 사회 공학 : 기술적인 방법이 아닌 사람들간의 기본적인 신뢰를 기반으로 사람을 속여 비밀정보를 획득하는 기법 주의

## 9.8 황금률
- 자체 암호화 / 자체 보안 프로토콜 금지
- AES같은 확실한 업계 기술을 사용해라.

## 9.9 보안 탑재
- 개발자에게 보안 문제에 대한 교육하기
    - [OWASP Top Ten](https://owasp.org/www-project-top-ten/) : 3년 주기로 발표되는 웹 애플리케이션 보안 위협 동향
    - [OWASP's 보안 테스팅 프레임워크](https://owasp.org/www-project-web-security-testing-guide/)
- 시스템의 취약점을 탐지할 수 있는 자동화 도구들
    - Zed Attack Proxy, Ruby용 Brakeman 등


## 9.10 외부 검증
- 특히 보안에는 외부의 평가가 가치있다. 정보보안 전담팀 / 외부 업체의 힘을 빌려라.
