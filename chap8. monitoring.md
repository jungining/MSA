#  8. 모니터링
- 목표 : 세분화된 시스템에서 발생하는 문제의 인식, 모니터링에 연관된 도전(Challenges)를 살펴보고, 우리가 할 수 있는것을 생각해보자.
- 문제상황 : 마이크로서비스가 세분화될수록 모니터링 관점에서 볼 때 복잡성도 증가한다.
- 해결책 : 작은 것들을 모니터링하고 전체 상황을 볼 수 있도록 취합


단일 노드에서부터 시작해보자.

## 1. 단일 서비스, 단일 서버

![image](https://user-images.githubusercontent.com/11023497/122734638-3a126980-d2b9-11eb-9a47-c72e13e66952.png)

- 호스트 자체 : CPU / 메모리의 정상 범위를 알고 있어야 문제시에 알 수 있다.
    - [나기오스](https://www.nagios.com/) : 네트워크 모니터링 소프트웨어, 자체 모니터링 소프트웨어 사용하는 경우
    - [뉴 렐릭](https://newrelic.com/kr) : 서비스 모니터링의 최강자(?), 호스팅 서비스
- 서버 자체 : 로그로테이트로 에러 리포트시 에러 추출, 언제 어디서 발생하는지 알려주어야 한다.
    - [logrotate](https://man7.org/linux/man-pages/man8/logrotate.8.html) : 리눅스에서 로그 로테이션을 하는 일반적인 방법 중 하나.
- 애플리케이션 자체 : 서비스의 응답시간을 모니터링

## 2. 단일 서비스, 다수 서버

![image](https://user-images.githubusercontent.com/11023497/122734733-4c8ca300-d2b9-11eb-9b6c-6a2144f9dc8b.png)

- 요청이 로드밸런서(load balancer)에 의해 다른 서비스 인스턴스로 전달된다.
- 문제를 격리할 수 있는 방법으로 진행해야 한다.
- 모든 것을 취합하고 세부 분석을 할 수 있어야 한다. (나기오스 호스트 그룹 기능 사용)
- 로그 : ssh-multiplexer와 같은 도구 사용 가능


## 3. 다수 서비스, 다수 서버

![image](https://user-images.githubusercontent.com/11023497/122734793-5c0bec00-d2b9-11eb-8e3b-caef00688a70.png)

많은 호스트에서 생성되는 수천 줄의 로그에서 에러를 어떻게 발견할 수 있을까?
- 해결책 : 로그 / 애플리케이션 측정 지표 까지 가능한 한 많은 수집과 집중식 취합을 하는 것 (Ex. [kibana logstash](https://www.elastic.co/kr/logstash))

![image](https://user-images.githubusercontent.com/11023497/122736686-3ed81d00-d2bb-11eb-8634-d729e67b306e.png)


## 다수 서비스 간의 측정지표 추적
- 복잡한 시스템에서 측정지표를 살펴볼 때는 어느 것이 정상 상태인지 알기 어렵다.
- 해결법 : 명확한 패턴이 드러나도록 오랜 기간에 걸쳐 시스템의 행동 방식에 대한 측정지표(metrics)를 수집하는 것이다.
- [그래파이트(Graphite)](https://graphiteapp.org/) :  웹 사이트, 어플리케이션, 특정 데이터나 서버를 모니터링 하는 툴
    1. 실시간으로 측정지표 전송
    2. 측정지표에 대한 질의
    3. 볼륨이 지나치게 커지지 않도록 오래된 측정지표의 해상도를 낮춰 효과적으로 구성
- 측정지표 추이로 얻는 혜택 : 
    1. 인스턴스에 대한 응답시간을 알 수 있다.
    2. 용량 계획(capacity planning)에 용이하다.

## 서비스 측정지표
- 서비스 스스로 기본적인 측정지표(응답시간, 에러율)을 발산해야 한다. 그 이유는, 
    1. 소프트웨어 기능의 80%는 이용되지 않기 때문
    2. 시스템을 어떻게 개선해야할지 알기 위해 사용자가 우리 시스템을 사용하는 방식에 이전보다 더 잘 대응하고 있기 때문
    3. 우리는 어떤 데이터가 유용할지 알 수 없기 때문이다.

## 합성 모니터링
- 운영중인 시스템에 자동화된 테스트의 하위 집합을 실행해 모니터링하는 기술
- directed(통제된) monitoring, active(능동) monitoring, semantic(유의적) monitoring으로 불린다.
- EX : 합성(가상) 트랜잭션 사용

### Semantic(유의적) monitoring
- 엔드 투 엔드 테스트는 유의적 모니터링 구현에 필요한 많은 것을 이미 보유하고 있다.
- 필요한 추가 작업 : 
    - 테스트의 요구 사항에 주의 (ex, 실제 데이터 시간이 지나면 바뀌는 경우)
    - 예측하지 못한 부작용을 만들지 않도록 보장해야 한다.

## 상관관계 ID
- 상관 관계 ID 사용시 상향 호출 체인 추적가능
- 첫 호출이 이뤄질 때 호출에 대한 전역 호출 식별자(globally unique identifier, GUID) 생성하고 후속하는 모든 호출에 전달, 로그에 넣기
- event storm, coner case 추적 가능
- [Zipkin](https://zipkin.io/) : 시스템 경계를 넘나드는 호출도 추적 가능, 서비스 상호 호출 자세히 추적
- Zipkin을 이용한 MSA 환경에서 분산 트렌젝션의 추적 [조대협의 블로그](https://bcho.tistory.com/1243)

![image](https://t1.daumcdn.net/cfile/tistory/99903A4C5AB662610D)

## 전파
- 전파 장애(cascading failure) : 서비스 간의 네트워크 접속이 다운된 상태, 서비스 자체는 정상이지만 서로 통신할 수 없다.
- 통합 지점을 모니터링하는것, 하위 의존성 상태를 추적 / 노출 하는것이 중요
- 회로 차단기 : 전파 장애를 다루는데 도움을 줌. (ex. JVM 히스트릭스 : 지연시간 및 장애 내성 로직을 추가하여 분산 서비스들간의 상호작용을 통제하는 라이브러리)

## 표준화
모니터링은 표준화가 엄청나게 중요한 분야다.

- 표준 포맷으로 로그 출력
- 모든 시스템의 측정지표를 한 곳에두어야 한다.

## 관객 고려하기

1. 어떤 것을 당장 알아야 하는가?
2. 어떤 것을 나중에 알아도 되는가?
3. 어떻게 데이터를 소비하고 싶은가?

를 고려해서 데이터를 수집하고, 모니터링(주의경보, 대시보드 이용)하라.

## 정리

서비스
- 최소한 응답시간 / 에러율 추적은 해라.
- 모든 하위 응답상태를 추적하라.
- 측정지표가 수집될 방식 / 저장소 / 로그 포맷 표준화하라.

시스템
- 호스트 레벨 측정지표도 취합하라.
- 개별 호스트 레벨까지 탐색해서 보여줘라
- 로그를 취합/저장하는데 가능한 한개의 도구를 사용하라.
- 주의경보와 대시보드를 적절히 구조화하라.
